#!/bin/zsh

if [[ -f ~/.massbuild ]]; then
    source ~/.massbuild
fi
if [[ -f .massbuild ]]; then
    source .massbuild
fi
if [[ $# -gt 0 ]]; then
    pkgnames=($*)
fi

[[ ${pkgnames:+1} == 1 ]] || echo error: specify pkgnames 1>&2 && exit
[[ ${prefix:+1} == 1 ]] || echo error: specify prefix 1>&2 && exit

update-package() {
    # update source
    mkdir -p src
    export srcdir=`pwd`/src
    export distdir=`pwd`/src
    (cd src; src)
    # build
    rm -rf dist build
    mkdir build
    (cd build; build) &&
    # record package files
    find dist -not -type d -a -printf '/%P\n' >>pkgfiles.new &&
    # remove old package files
    touch pkgfiles &&
    xargs rm -r {} <pkgfiles &&
    # install package
    cp -r dist/* / &&
    # update pkgfiles
    mv pkgfiles.new pkgfiles
}

for i in $pkgnames; do
    mkdir -p $i
    (cd $i
     source .localbuild
     pkgname=$i update-package)
done
